(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-11c72313"],{"524f":function(s,e,a){"use strict";a.r(e);var t=function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("div",[s.isLoadingStudents?a("div",[s._v("\n    正在获取学员详情...\n  ")]):a("div",[a("h3",[s._v(s._s(s.classInfo.name)+" -- 学员管理")]),a("ClassAdmin",{key:s.initComponentKey,attrs:{forStudentManagement:!0}}),a("hr"),a("div",{staticClass:"input-group mb-3"},[a("input",{directives:[{name:"model",rawName:"v-model",value:s.newClassTeamName,expression:"newClassTeamName"}],staticClass:"form-control",attrs:{type:"text","aria-describedby":"basic-addon2",placeholder:"输入新组名称"},domProps:{value:s.newClassTeamName},on:{input:function(e){e.target.composing||(s.newClassTeamName=e.target.value)}}}),a("b-button",{attrs:{variant:"info"},on:{click:s.createClassTeam}},[s._v("创建新组")]),s.classTeamsChanged?a("b-button",{attrs:{variant:"success"},on:{click:s.submitClassTeams}},[s._v("保存修改")]):s._e(),s.classTeamsChanged?a("b-button",{attrs:{variant:"warning"},on:{click:s.resetClassTeams}},[s._v("放弃修改")]):s._e()],1),s.removedStudents.length>0?a("ClassTeam",{attrs:{classTeam:s.dummyClassTeam()}}):s._e(),s._l(s.classTeams,(function(e,t){return a("div",{key:e.id+e.name+t},[a("ClassTeam",{attrs:{classTeam:e}}),t>0?a("b-button",{attrs:{block:"",variant:"warning"},on:{click:function(e){return s.removeClass(t)}}},[s._v("删除本组")]):s._e(),a("hr")],1)}))],2)])},n=[],i=a("2f62"),l=a("cfac"),c=function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("div",[a("b-card",{staticClass:"text-center",attrs:{header:"中组管理"}},s._l(s.classAdminUsers,(function(e,t){return a("b-input-group",{key:t,staticClass:"mt-3",attrs:{prepend:e.role}},[a("b-form-input",{attrs:{readonly:"",value:e.displayName}}),a("b-input-group-append",[a("b-form-select",{attrs:{options:s.classAdminOptions(t)},on:{input:function(e){return s.changeMember(e,t)}},model:{value:s.newClassAdmins[t],callback:function(e){s.$set(s.newClassAdmins,t,e)},expression:"newClassAdmins[index]"}})],1)],1)})),1)],1)},m=[],r=a("6c33"),o={name:"ClassAdmin",props:{forStudentManagement:Boolean},data:function(){return{classAdminCandidates:[],classStatsCandidates:[],newClassAdmins:[]}},computed:{...Object(i["c"])(["classInfo","classTeams","classAdminUsers"])},mounted(){this.buildNewClassAdmin(),this.buildOptions()},methods:{buildNewClassAdmin(){const s=[];for(var e=0;e<this.classAdminUsers.length;e++){const a=this.classAdminUsers[e];s.push(a.id)}this.newClassAdmins=s},buildOptions(){this.classAdminCandidates=[];for(var s=0;s<this.classInfo.classAdminStudents.length;s++){const e=this.classInfo.classAdminStudents[s];e&&e.roles.some(s=>"ClassAdminUser"==s)&&this.classAdminCandidates.push(e)}for(this.classAdminCandidates=this.classAdminCandidates.concat(this.classInfo.classAdminCandidates),this.classAdminCandidates=this.classAdminCandidates.map(s=>({value:s.id,text:s.name,roles:s.roles})),this.classStatsCandidates=[],s=0;s<this.classTeams.length;s++){const a=this.classTeams[s];for(var e=0;e<a.members.length;e++){const s=a.members[e];this.classAdminCandidates.some(e=>e.value==s.id)||this.classStatsCandidates.push({value:s.id,text:s.name,roles:s.roles})}}},classAdminOptions(s){return s<2?this.classAdminCandidates:this.classStatsCandidates},changeMember(s,e){if(s==this.classAdminUsers[e].id)return;console.log(`selected ${s} index: ${e}`);const a=this.classAdminOptions(e);for(var t=0;t<a.length;t++){const n=a[t];if(n.value==s){this.classAdminUsers[e].id=s,this.classAdminUsers[e].name=n.name,this.classAdminUsers[e].displayName=`(${e+1}) ${n.text}`;break}}this.$store.dispatch(r["q"],{changed:!0})}}},d=o,u=a("2877"),h=Object(u["a"])(d,c,m,!1,null,null,null),p=h.exports,T=a("4360"),b=a("bf48"),f=a.n(b),g={name:"StudentManagement",components:{ClassTeam:l["a"],ClassAdmin:p},computed:{...Object(i["c"])(["isLoadingStudents","classInfo","classTeams","isClassAdmin","isSystemAdmin","classTeamsChanged","removedStudents","initComponentKey","classAdminUsers"])},beforeRouteEnter(s,e,a){T["a"].dispatch(r["i"],s.params).then(()=>{a()})},data:function(){return{newClassTeamName:"",creatingClassTeam:!1}},methods:{dummyClassTeam(){return{id:`DUMMY_${this.newClassTeamName}_${(new Date).getTime()}`,dummy:!0,name:"将删除学员",members:this.removedStudents}},createClassTeam(){const s={id:`NEW_${this.newClassTeamName}_${(new Date).getTime()}`,classId:this.classInfo.id,name:this.newClassTeamName,members:[]};this.newClassTeamName="",this.classTeams.push(s),T["a"].dispatch(r["q"],{changed:!0})},removeClass(s){this.classTeams[0].members=this.classTeams[0].members.concat(this.classTeams[s].members),this.classTeams.splice(s,1),T["a"].dispatch(r["q"],{changed:!0})},resetClassTeams(){const s={okText:"确认",cancelText:"取消",loader:!0},e={title:this.classInfo.name,body:"放弃所做修改?"},a=this;this.$dialog.confirm(e,s).then((function(s){a.newClassTeamName="",a.classInfo.changed=!1,T["a"].dispatch(r["q"],a.classInfo),s.close()})).catch(s=>{console.log("error: "+s)})},submitClassTeams(){const s={okText:"确认",cancelText:"取消",loader:!0},e={title:this.classInfo.name,body:"保存所做修改?"},a=this,t=this.classInfo.id,n=this.classTeams.filter(s=>s.id),i=this.removedStudents,l=this.classAdminUsers.map(s=>s.id);console.log("updateTeams - classAdminUserIds: "+JSON.stringify(l)),this.$dialog.confirm(e,s).then((function(s){f.a.Cloud.run("class:updateTeams",{classId:t,classTeams:n,removedStudents:i,classAdminUserIds:l}).then(e=>{console.log("updateTeams - result: "+JSON.stringify(e)),window.location.reload(),s.close()}).catch(e=>{console.log("error in updateTeams: "+e),s.close(),a.$dialog.alert("error in updateTeams: "+e)})})).catch(s=>{console.log("error: "+s)})}}},C=g,v=Object(u["a"])(C,t,n,!1,null,null,null);e["default"]=v.exports},cfac:function(s,e,a){"use strict";var t=function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("div",[a("b-card",{staticClass:"text-center",attrs:{header:s.classTeam.name}},[s.classTeam.dummy?a("b-card-text",[s._v("\n      将删除 "+s._s(s.classTeam.members.length)+" 名学员\n    ")]):null==s.classTeam.id?a("b-card-text",[s._v("\n      共有 "+s._s(s.classTeam.members.length)+" 名学员未分组\n    ")]):a("b-card-text",[s._v("\n      本组共有 "+s._s(s.classTeam.members.length)+" 名学员\n    ")]),s._l(s.classTeam.members,(function(e,t){return a("b-input-group",{key:e.id+t,staticClass:"mt-3",attrs:{prepend:null==s.classTeam.id||s.classTeam.dummy?"学员：":s.classTeam.dummy||0!=t?"组员：":"组长："}},[s.classInfo.forAdmin?a("b-form-input",{attrs:{readonly:"",value:"("+(t+1)+") "+e.name}}):s.classInfo.practiceId?a("b-form-input",{attrs:{readonly:"",value:"("+(t+1)+") "+e.name+"\t上周："+(e.lastWeek?e.lastWeek.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"):"未报数")+"\t总计："+(e.count?e.count.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"):"未报数")+"\n          "}}):a("b-form-input",{attrs:{readonly:"",value:"("+(t+1)+") "+e.name+"\t上周："+e.lastWeek+"\t总计："+e.count+"\n          "}}),s.isClassAdmin&&!s.classInfo.forAdmin&&s.classInfo.practiceId?a("b-button",{attrs:{variant:"success",disabled:e.completed},on:{click:function(e){return s.setCompleted(t)}}},[s._v(s._s(e.completed?"已圆满":"圆满"))]):s._e(),a("b-input-group-append",[s.classInfo.forAdmin?a("div",[null==s.classTeam.id?a("b-form-select",{attrs:{options:s.classTeamOptions},on:{change:function(e){return s.assignTeam(e,t)}},model:{value:e.assignedTeamId,callback:function(a){s.$set(e,"assignedTeamId",a)},expression:"member.assignedTeamId"}}):s._e(),!s.classTeam.dummy&&s.classTeam.id&&t>0?a("b-button",{attrs:{variant:"info"},on:{click:function(e){return s.setLeader(t)}}},[s._v("设为组长")]):s._e(),a("b-button",{attrs:{variant:"warning"},on:{click:function(e){return s.removeMember(t)}}},[s._v(s._s(s.classTeam.dummy?"恢复":"删除"))])],1):s._e()])],1)}))],2)],1)},n=[],i=a("bf48"),l=a.n(i),c=a("2f62"),m=a("6c33"),r={name:"ClassTeam",props:{classTeam:{type:Object,required:!0}},data:function(){return{canAddSubmodule:!1}},computed:{...Object(c["c"])(["isClassAdmin","classInfo","classTeams","classTeamsChanged","classTeamOptions","removedStudents"])},methods:{assignTeam(s,e){console.log(`selected: ${s} index: ${e}`);const a=this.classTeam.members[e];this.classTeam.members.splice(e,1);for(var t=0;t<this.classTeams.length;t++){const s=this.classTeams[t];if(s.id==a.assignedTeamId){a.assignedTeamId=null,s.members.push(a);break}}this.$store.dispatch(m["q"],{changed:!0})},removeMember(s){const e=this.classTeam.members[s];this.classTeam.members.splice(s,1),this.classTeam.id?this.classTeams[0].members.push(e):this.removedStudents.push(e),this.$store.dispatch(m["q"],{changed:!0})},setLeader(s){const e=this.classTeam.members[s];this.classTeam.members.splice(s,1),this.classTeam.members.splice(0,0,e),this.$store.dispatch(m["q"],{changed:!0})},setCompleted(s){const e=this.classTeam.members[s];console.log("setCompleted - "+JSON.stringify(e));var a=`确认${e.name}已圆满${this.classInfo.practiceName}实修?`;const t={okText:"确认",cancelText:"取消",loader:!0},n={title:this.classInfo.practiceName,body:a},i=this;this.$dialog.confirm(n,t).then((function(s){l.a.Cloud.run("admin:markUserPracticeCompleted",{userId:e.id,practiceId:i.classInfo.practiceId}).then(a=>{console.log("markUserPracticeCompleted - result: "+JSON.stringify(a)),e.completed=a.completed,s.close(),window.location.reload()}).catch(e=>{console.log("error in markUserPracticeCompleted: "+e),s.close(),i.$dialog.alert("error in markUserPracticeCompleted: "+e)})})).catch(s=>{console.log("error: "+s)})}}},o=r,d=a("2877"),u=Object(d["a"])(o,t,n,!1,null,null,null);e["a"]=u.exports}}]);
//# sourceMappingURL=chunk-11c72313.1db1bea4.js.map